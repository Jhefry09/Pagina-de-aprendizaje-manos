
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reconocimiento de Vocales por Mano</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1 { color: #2c3e50; }
        select { padding: 10px; margin: 5px 0; font-size: 16px; }
        #scoreContainer { margin-top: 10px; font-weight: bold; font-size: 18px; width: 640px; background: #ecf0f1; border-radius: 10px; overflow: hidden; }
        #scoreBar { height: 25px; background: #27ae60; width: 0%; transition: width 0.1s; text-align: center; color: white; line-height: 25px; font-weight: bold; }
        canvas { position: absolute; left: 0; top: 0; }
        #videoWrapper { position: relative; width: 640px; height: 480px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
    <h1>Reconocimiento de Vocales por Mano</h1>
    <label for="vocalSelect">Selecciona una vocal:</label>
    <select id="vocalSelect">
        <option value="a">A</option>
        <option value="e">E</option>
        <option value="i">I</option>
        <option value="o">O</option>
        <option value="u">U</option>
    </select>

    <div id="scoreContainer">
        <div id="scoreBar">0%</div>
    </div>

    <div id="videoWrapper">
        <video id="video" width="640" height="480" autoplay muted></video>
        <canvas id="canvas" width="640" height="480"></canvas>
    </div>

    <script>
        // ===== WebSocket y precarga de datos =====
        let stompClient = null;
        let vocalesBase = [];

        function connectWS() {
            const socket = new SockJS('/vocales-websocket');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                console.log('Conectado al WS:', frame);

                // Subscribir para recibir los datos
                stompClient.subscribe('/topic/vocales', function(message) {
                    vocalesBase = JSON.parse(message.body);
                    console.log("Datos precargados:", vocalesBase);
                });

                // Solicitar los datos apenas se conecte
                requestData();
            });
        }

        function requestData() {
            if(stompClient && stompClient.connected){
                stompClient.send("/app/getVocales", {}, {});
            }
        }

        // ===== Configuración MediaPipe Hands =====
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640,
            height: 480
        });
        camera.start();

        function normalizeLandmarks(landmarks) {
            const cx = landmarks.reduce((sum, p) => sum + p.x, 0)/landmarks.length;
            const cy = landmarks.reduce((sum, p) => sum + p.y, 0)/landmarks.length;
            const cz = landmarks.reduce((sum, p) => sum + p.z, 0)/landmarks.length;
            let normalized = landmarks.map(p => ({x: p.x - cx, y: p.y - cy, z: p.z - cz}));
            const maxDist = Math.max(...normalized.map(p => Math.sqrt(p.x*p.x + p.y*p.y + p.z*p.z)));
            normalized = normalized.map(p => ({x: p.x/maxDist, y: p.y/maxDist, z: p.z/maxDist}));
            return normalized;
        }

        function compareHands(landmarks1, landmarks2) {
            const n = Math.min(landmarks1.length, landmarks2.length);
            let totalDist = 0;
            for(let i=0;i<n;i++){
                const dx = landmarks1[i].x - landmarks2[i].x;
                const dy = landmarks1[i].y - landmarks2[i].y;
                const dz = landmarks1[i].z - landmarks2[i].z;
                totalDist += Math.sqrt(dx*dx + dy*dy + dz*dz);
            }
            let similarity = Math.max(0, Math.min(1, 1 - (totalDist/n)));
            return (similarity*100).toFixed(1);
        }

        function onResults(results) {
            canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height);

            if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0){
                const handLandmarks = results.multiHandLandmarks[0];
                const handedness = results.multiHandedness[0].label; 

                drawConnectors(canvasCtx, handLandmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                drawLandmarks(canvasCtx, handLandmarks, {color: '#FF0000', lineWidth: 1});

                let normalizedHand = normalizeLandmarks(handLandmarks);
                if(handedness === "Left"){
                    normalizedHand = normalizedHand.map(p => ({x:-p.x, y:p.y, z:p.z}));
                }

                const selectedVocal = document.getElementById("vocalSelect").value;
                const vocalBase = vocalesBase.find(v => v.vocal === selectedVocal);
                if(vocalBase){
                    const baseLandmarks = normalizeLandmarks(JSON.parse(vocalBase.vectoresJson).landmarks);
                    const score = compareHands(normalizedHand, baseLandmarks);

                    document.getElementById("scoreBar").style.width = score + "%";
                    document.getElementById("scoreBar").innerText = score + "%";
                }
            }
        }

        // ===== Inicialización =====
        window.onload = () => connectWS();
    </script>
</body>
</html>

